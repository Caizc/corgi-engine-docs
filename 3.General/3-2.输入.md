# 输入

[Input](http://corgi-engine-docs.moremountains.com/input.html)

> 这个页面说明了如何在你的游戏中设置输入。

## 简介

输入是所有游戏的核心，在 Corgi Engine 中也不例外。引擎当前支持移动设备操控（iOS、Android...）、键盘、游戏手柄（初始设置为 Windows Xbox 手柄，但可以重新绑定为其他控制器的键位）以及鼠标。

## 默认输入

默认的键盘布局被设置为同时支持 4 位玩家。目前对于单玩家游戏来说，这个键位可能并不是特别舒服，请按照你的需求任意重新映射这些按键。不管怎样，这是默认布局：

![默认的键盘布局，同时支持 4 位玩家](media/15011432639033.jpg)

## 输入设置：如何更改键位绑定？

![很多轴](media/15011436782426.jpg)

对于键盘和游戏手柄（以及较少程度上的鼠标），键位绑定就像在任何优秀的 Unity 项目中一样，**通过原生的 Input 设置**进行设定。你可以通过顶部菜单 `Edit > Project Settings > Input` 来访问这些设置，这样应该可以打开一个很长的 Axes 列表。如果你之前没有了解过这个面板，可能需要[先阅读一下官方文档](https://docs.unity3d.com/Manual/class-InputManager.html)。

目前这个列表相当长，为了支持 4 个玩家而被填满（你想要的话还可以添加更多），并且可以说是一个关键的配置。你可以任意地**编辑这些配置**，根据你的偏好重新绑定键位。

## Input Manager 与 GUI

通常使用**输入（Input）**来移动屏幕上的角色，无论是通过触摸屏幕还是按下机械按键。Corgi Engine 用 Input Manager 组件来处理输入检测并将其传递给角色。Corgi Engine 的大部分关卡都有一个 UICamera 对象。这个 UICamera Prefab 也有一堆移动控制相关的东西，用来在移动设备上控制玩家角色。为此，同时为了让绑定更加简单，你会发现 InputManager 组件放置在 UICamera Prefab 的顶层。你愿意的话也可以将它放置在单独的 GameObject 上。

`InputManager` 是一个很长的类，不过如果你细看一下就会发现它并不复杂，只是非常琐碎。它有很多让你能够绑定移动设备控制的方法，以及为每一个登记的按键管理一个小状态机。

在它的 Inspector 视窗你可以指定 **Player ID**（阅读下一小节以了解详细信息），无论你使用的是移动设备检测还是强制使用移动设备控制。你也可以决定使用虚拟方向键/十字键或者虚拟操纵杆。最后你可以设置平滑运动的开关（当按下按键时是应该即时移动还是要快速的线性插值？），还有水平和竖直方向的阈值。

## Player ID

![InputManager 的 PlayerID（右图）必须匹配你要操控的角色中的 PlayerID](media/15011514343185.jpg)

这里要理解的一个重要概念就是 **Player ID**。引擎能够从 InputManager 获得输入然后发送给场景中的玩家角色（带有 `Character` 组件且类型设置为 `Player` 的对象）。每一个 InputManager 都有一个 `Player ID` 属性，它会将它的信息发送给所有匹配上 `Player ID` 属性的角色。所以有一些方法可以让它工作：

* 最普遍的方法是**交给引擎来处理**。添加一个 InputManager 组件到场景中，设置它的 `Player ID` 为 `Player1`。然后在 LevelManager 对象的 Inspector 视窗中，当你添加完角色后（在 Player Prefabs 设置项下面），勾选 `Auto Attribute Player IDs`，接着它就会自动标识玩家角色的 ID 为 `Player1`。如果在一个多玩家关卡中，则会使用 `Player2`、`Player3` 和 `Player4`。当然你也可以添加自定义的 `Player ID`，但以上这些是默认的。
* 你也可以**在 Prefab 上**设置 `Player ID`。例如有一个 Dog 角色，它的 `Player ID` 是 `JoeTheDog`。如果你添加了一个 InputManager 到场景中，并且想设置它的目标为这个 Dog 角色，那么设置它的 `Player ID` 参数为 `JoeTheDog` 即可。按下 Play 按钮，应当就可以控制你的 Dog 角色了。如果由于某些原因你不想使用 LevelManager，又想马上移动场景中的 Prefab 时，使用这种方法就非常好。

当调整一个角色的时候，我更多地使用第二种方法。例如我想要修改角色上的跳跃行为，我只需要拷贝该角色的 Prefab，把这个拷贝放到场景中，并且设置它的 `Player ID` 为 `Player1`。然后在 LevelManager 中，将原始的 Prefab 设置为关卡的 Player Prefab。按下 Play 按钮，现在我就可以使用同样的输入控制两个角色（调整前和调整后的）啦。接下来我可以更改其中一个的跳跃设置（甚至用一个新的跳跃脚本替换掉旧的），快速地测试这两个角色，看看这些更改是否提升了游戏体验。

## 平台检测是如何工作的？

在 InputManager 组件的 Inspector 视窗中，你可以开启或关闭 **Auto Mobile Detection**。

如果你展开 UICamera Prefab，会发现它包含了很多东西，最明显的就是方向键（Arrows）、操纵杆（Joystick）和按键（Buttons）这几个画布分组（Canvas Groups）。它们**默认为不可用（Disable）**，以适应更简单的关卡，但你也可以开启或者调整它们。这些（以及其他东西）都是在 GUIManager 组件中绑定的。移动设备检测的工作方式很简单：如果你的目标是移动设备平台（iOS 或者 Android），当你按下 Play 按钮的时候这些操纵组件会显示出来；如果你的目标是其他平台，它们就会**隐藏且变为不可用**。通过 Inspector 视窗，你可以强制设置为任何一种模式。

## 虚拟方向键、操纵杆和按钮

![方向键的 Touch Axis 组件的 Inspector](media/15012114241306.jpg)

Corgi Engine 资源中包含了完整功能的十字方向键、操纵杆和一些按钮，当然你也可以将它们混合搭配使用，添加新的按钮、操纵杆等等，以适配你的游戏玩法。

**移动方向键（Mobile Arrows）**非常简单，只需要将一个 `MMTouchAxis` 组件放置在一个 Rect+CanvasGroup 对象上。接着在它的 Inspector 视窗中设置 `Axis Value`（通常对于左/下为 `-1`，对于右/上为 `1`），然后将它的` Axis Pressed` 事件绑定到 InputManager。操作方法是，拖拽 InputManager（大部分情况下在场景的 UICamera 对象下）到 `Runtime Only` 下方的小方框中，然后选择适当的方法（`SetVerticalMovement`、`SetHorizontalMovement` 或者对应 Secondary 方法）。

**移动操纵杆（Mobile Joysticks）**甚至更容易设置。只需要添加一个 `MMTouchAxis` 组件到一个 Rect+CanvasGroup 对象上，设定哪个轴是可用的（比如你只想要一个水平方向的操纵杆），`Max Range`（球形柄离原始位置的最大距离），最后再绑定到 InputManager。注意你还需要指定一个目标摄像头（`Target Camera`，通常是场景中的 UICamera）。

**按钮（Buttons）**的工作方式也一样，但你可以为它们指定 3 种不同的事件：`Button Down`（当它第一次被按下时），`Button Up`（但它被松开时），以及 `Button Pressed`（当它在某一帧被按下时）。这样你就可以在某个按钮松开时让你的 Character Ability 组件（举个例子）调用某个方法了。你不需要绑定所有事件，如果你没有全用到它们的话。

## Nice Touch

Corgi Engine 包含了另一个由 More Mountains 出品的插件：[Nice Touch](https://www.assetstore.unity3d.com/cn/#!/content/65358)。如果你已经有了 Corgi Engine 就不用再买它了！我创建 Nice Touch 是为了提供一个简单快速的输入解决方案。它负责处理键盘、游戏手柄和触摸屏幕输入。除此之外还有很多其他的输入解决方案。有一段时间 Corgi Engine 使用的是 Unity 的标准资源中的 `CrossPlatformInput` 组件。创建 Nice Touch/MMControls 是为了提供一个更简单的替代品，更快捷的设置，而除去那些不必要的设置。你也可以用回自己的组件而不一定要使用这些。

你可以在路径 `MMTools/MMControls` 下找到这些脚本，在同一个目录底下还包含了一个测试场景：MMControlsTestScene。你需要在你的游戏中保持这个目录。

-------


